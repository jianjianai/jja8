<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=zh-CN lang=zh-cn><head><link href=https://gmpg.org/xfn/11 rel=profile><meta charset=utf-8><meta name=generator content="Hugo 0.104.2"><meta name=viewport content="width=device-width,initial-scale=1"><title>Java Ping Mc服务器的方法:github上找了个例子，直接复制就完事了。</title><meta name=description content><meta name=baidu-site-verification content="code-zuAAizjiM8"><meta name=msvalidate.01 content="07632F39AB3B1DE13D72819912B5F3C5"><meta name=description content="简的秘密基地，发布一些有意思的作品。"><link type=text/css rel=stylesheet href=https://www.jja8.cn/css/整体效果.css><link type=text/css rel=stylesheet href=https://www.jja8.cn/css/文章.css><link rel="shortcut icon" href=https://www.jja8.cn//插件实验室.png></head><body><div id=导航栏><div id=网站标识><img class=网站图标 src=https://www.jja8.cn//插件实验室.png><div id=站点文本><h1 id=站点文本标题><span><a href=/ title=w.jja8.cn:88 rel=home>简的秘密基地</a></span></h1><span id=网站表示简介>jja8.cn</span></div></div><div><ul style=margin-right:14px><li class=导航栏列表><a href=/ target=_self>主页</a>
<a href=/tags target=_self>分类</a></li></ul></div></div><div id=主页面><div id=文章布局框><div id=标题卡片 style=background-image:url(https://www.jja8.cn/img/java%20ping%20mc%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%9a%84%e6%96%b9%e6%b3%95/tech2.jpg)><div id=文章元素背景><div id=文章元素框><h2 id=文章标题>Java Ping Mc服务器的方法</h2><p id=文章简介>github上找了个例子，直接复制就完事了。</p><p id=文章时间日期>2022-08-29 15:20</p><p id=文章提要>复制粘贴，然后再改改。就变成自己的了，哈哈。</p></div></div></div><div id=文章内容框><div id=文章内容正文><h1 id=java-ping-mc服务器的方法>Java Ping Mc服务器的方法</h1><p>最近搞了个mc服务器检测的项目，于是就在网上查找mc ping的协议。之后就找到了个例子：https://gist.github.com/zh32/7190955</p><p>这个例子是真的好用。我把它简单修改了下，一行代码就可以ping服务器。 其实只是把返回void变成了this</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Java data-lang=Java><span style=display:flex><span>ServerListPing<span style=color:#f92672>.</span><span style=color:#a6e22e>StatusResponse</span> pingSata <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> ServerListPing<span style=color:#f92672>().</span><span style=color:#a6e22e>setTimeout</span><span style=color:#f92672>(</span>1000<span style=color:#f92672>).</span><span style=color:#a6e22e>setAddress</span><span style=color:#f92672>(</span><span style=color:#66d9ef>new</span> InetSocketAddress<span style=color:#f92672>(</span>server<span style=color:#f92672>.</span><span style=color:#a6e22e>address</span><span style=color:#f92672>,</span> server<span style=color:#f92672>.</span><span style=color:#a6e22e>port</span><span style=color:#f92672>)).</span><span style=color:#a6e22e>fetchData</span><span style=color:#f92672>()</span>
</span></span></code></pre></div><p>这个例子用到了gson，记得添加一个依赖哦</p><pre tabindex=0><code>dependencies {
    implementation &#39;com.google.code.gson:gson:2.9.0&#39;
}
</code></pre><p>下面是修改过的例子</p><pre tabindex=0><code>import com.google.gson.Gson;
import java.io.ByteArrayOutputStream;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.net.InetSocketAddress;
import java.net.Socket;
import java.util.List;

/**
 *  https://gist.github.com/zh32/7190955
 * @author zh32 &lt;zh32 at zh32.de&gt;
 */
public class ServerListPing {

    private InetSocketAddress host;
    private int timeout = 7000;
    private Gson gson = new Gson();

    public ServerListPing setAddress(InetSocketAddress host) {
        this.host = host;
        return this;
    }

    public InetSocketAddress getAddress() {
        return this.host;
    }

    ServerListPing setTimeout(int timeout) {
        this.timeout = timeout;
        return this;
    }

    int getTimeout() {
        return this.timeout;
    }

    public int readVarInt(DataInputStream in) throws IOException {
        int i = 0;
        int j = 0;
        while (true) {
            int k = in.readByte();
            i |= (k &amp; 0x7F) &lt;&lt; j++ * 7;
            if (j &gt; 5) throw new RuntimeException(&#34;VarInt too big&#34;);
            if ((k &amp; 0x80) != 128) break;
        }
        return i;
    }

    public void writeVarInt(DataOutputStream out, int paramInt) throws IOException {
        while (true) {
            if ((paramInt &amp; 0xFFFFFF80) == 0) {
                out.writeByte(paramInt);
                return;
            }

            out.writeByte(paramInt &amp; 0x7F | 0x80);
            paramInt &gt;&gt;&gt;= 7;
        }
    }

    public StatusResponse fetchData() throws IOException {

        Socket socket = new Socket();
        OutputStream outputStream;
        DataOutputStream dataOutputStream;
        InputStream inputStream;
        InputStreamReader inputStreamReader;

        socket.setSoTimeout(this.timeout);

        socket.connect(host, timeout);

        outputStream = socket.getOutputStream();
        dataOutputStream = new DataOutputStream(outputStream);

        inputStream = socket.getInputStream();
        inputStreamReader = new InputStreamReader(inputStream);

        ByteArrayOutputStream b = new ByteArrayOutputStream();
        DataOutputStream handshake = new DataOutputStream(b);
        handshake.writeByte(0x00); //packet id for handshake
        writeVarInt(handshake, 4); //protocol version
        writeVarInt(handshake, this.host.getHostString().length()); //host length
        handshake.writeBytes(this.host.getHostString()); //host string
        handshake.writeShort(host.getPort()); //port
        writeVarInt(handshake, 1); //state (1 for handshake)

        writeVarInt(dataOutputStream, b.size()); //prepend size
        dataOutputStream.write(b.toByteArray()); //write handshake packet


        dataOutputStream.writeByte(0x01); //size is only 1
        dataOutputStream.writeByte(0x00); //packet id for ping
        DataInputStream dataInputStream = new DataInputStream(inputStream);
        int size = readVarInt(dataInputStream); //size of packet
        int id = readVarInt(dataInputStream); //packet id

        if (id == -1) {
            throw new IOException(&#34;Premature end of stream.&#34;);
        }

        if (id != 0x00) { //we want a status response
            throw new IOException(&#34;Invalid packetID&#34;);
        }
        int length = readVarInt(dataInputStream); //length of json string

        if (length == -1) {
            throw new IOException(&#34;Premature end of stream.&#34;);
        }

        if (length == 0) {
            throw new IOException(&#34;Invalid string length.&#34;);
        }

        byte[] in = new byte[length];
        dataInputStream.readFully(in);  //read json string
        String json = new String(in);


        long now = System.currentTimeMillis();
        dataOutputStream.writeByte(0x09); //size of packet
        dataOutputStream.writeByte(0x01); //0x01 for ping
        dataOutputStream.writeLong(now); //time!?

        readVarInt(dataInputStream);
        id = readVarInt(dataInputStream);
        if (id == -1) {
            throw new IOException(&#34;Premature end of stream.&#34;);
        }

        if (id != 0x01) {
            throw new IOException(&#34;Invalid packetID&#34;);
        }
        long pingtime = dataInputStream.readLong(); //read response

        StatusResponse response = gson.fromJson(json, StatusResponse.class);
        response.setTime((int) (now - pingtime));

        dataOutputStream.close();
        outputStream.close();
        inputStreamReader.close();
        inputStream.close();
        socket.close();

        return response;
    }


    public class StatusResponse {
        private String description;
        private Players players;
        private Version version;
        private String favicon;
        private int time;

        public String getDescription() {
            return description;
        }

        public Players getPlayers() {
            return players;
        }

        public Version getVersion() {
            return version;
        }

        public String getFavicon() {
            return favicon;
        }

        public int getTime() {
            return time;
        }

        public void setTime(int time) {
            this.time = time;
        }

    }

    public class Players {
        private int max;
        private int online;
        private List&lt;Player&gt; sample;

        public int getMax() {
            return max;
        }

        public int getOnline() {
            return online;
        }

        public List&lt;Player&gt; getSample() {
            return sample;
        }
    }

    public class Player {
        private String name;
        private String id;

        public String getName() {
            return name;
        }

        public String getId() {
            return id;
        }

    }

    public class Version {
        private String name;
        private String protocol;

        public String getName() {
            return name;
        }

        public String getProtocol() {
            return protocol;
        }
    }
}
</code></pre></div></div></div></div><div id=页脚><div class=页脚内容><p>本设计由简.精心制作</p><a href=/>Copyright © 2016-2020 简的秘密基地. All rights reserved.</a></div></div></body></html>