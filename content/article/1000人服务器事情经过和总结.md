---
title: "1000人服务器事情经过和总结"
date: 2022-10-04T16:52:44+08:00
tags: ["简简爱", "动态"]
img: "img/1000人服务器事情经过和总结/封面.jpg"
synopsis: 庄主举办的1000人同屏竞技活动的经过的总结和分析。
summary: 服务商过于自信，我们技术团队没有服务器的控制权完全没法参与部署和测试。服务商也没有使用我们给出的方案部署服务器导致此次悲剧。
---

# 1000人服务器事情经过和总结

这次1000人同屏竞技活动我们准备的是非常充分的，在9月14日就开始讨论这次活动的内容，并且已经初步确认大致流程，也把任务都分配完成了。

我们开发团队一共三人，大米，夜光和我。
大米和我负责语音插件魔改，但是没有成功。夜光负责反作弊。
我还要负责MultiPaper服务端的部署和插件开发，所以这次活动的服务器架构和技术方案我是最清楚的。

## 事情经过

### 9月14日
我们初步确定了服务器架构使用MultiPaper，并且通过查阅资料确定了这种架构的服务端是完全可以容纳1000人同屏竞技是搓搓有余的，并且此服务端已经在国外有过两次大型活动并且非常成功，一次是550人，一次是1000人。

因为我们的开发环境是windows系统，为了方便迁移我们要求服务商也使用windows系统搭建服务器。

### 9月28日
我们完成了服务端的开发与调试，当时我们的计划是在10月1日举办活动。要求服务商提供服务器进行测试，服务商拒绝了我们的请求，要求我们将服务器打包发送给他们，他们帮我们部署。于是我将服务器打包发送给服务商。

### 9月29日 下午8:23
服务商说他们机房机器刚到货正在安装，无法部署服务端。
当天承诺给我们两台5900K CPU的机器用于举办活动。

### 9月30日 下午5:01
我们询问服务商情况得知他们依然没有完成服务端部署，理由是正在装系统。


### 10月1日 深夜00:23
庄主给我打了个电话，我没接到。迷迷糊糊醒来得知服务商在部署服务器时遇到了问题。
当我尝试联系服务商解决问题时，联系不上。

### 10月1日 上午7:26
负责与我们沟通的负责人说自己在机房睡着了。

### 10月1日 上午9:25
我指导他们解决了问题。

### 10月1日 上午10:21
服务商提出使用Velocity+multipaper方案，我回复可以。
并且指导他们配置Velocity服务端。

### 10月1日 上午11:39
因为服务器还没部署完成，活动已经确定要推迟了。
我继续指导服务商完成数据库连接等配置。

### 10月2日 晚上9:03
完成了全部服务器配置。
确定了活动时间10月3日下午举行。

### 10月3日 中文12:01
夜光指导服务商安装反作弊插件并完成配置。此时活动的消息已经放出。

### 10月3日 下午2:09
夜光开始对反作弊插件进行测试，并优化配置。

### 10月3日 下午6:10
反作弊插件微调完成，几乎所有外挂都无法逃避检测，并且不会出现误判了。

### 10月3日 下午7:10
服务器在线人数达到200人，此时服务器开始出现了卡顿，我尝试找到原因。一直查询各子服务器tps。
所有服务器都是20。初步排查的结果是因为网络带宽不够导致。于是联系服务商询问宽带使用情况，得知最大带宽是1Gbps，当时上行带宽不知，因为**我们团队没有服务器后台**。只能先向服务商申请提高上行带宽。并且要求服务商排查问题。


### 10月3日 下午7:40
服务器在线人数达到600人，并且伴随DDOS和假人攻击。
我们要求服务商给我们服务器后台，方便排查情况和解决攻击问题。并且要求服务商对TCP请求过多的ip进行封禁。


### 10月3日 下午7:52
我认为，假人攻击已经被解决。进入服务器的玩家不可能是假人，因为已经对单个ip的TCP请求做了限制。多出的请求直接丢弃，此时应该是大量玩家涌入。
此时我们仍然没有服务器后台，ip的tcp连接限制是服务商帮我们设置的。

夜光和大米提出增加登录服的方式解决假人攻击。
为了保险起见我也同意了此方案。
并且此时我去临时写一个禁止一个ip频繁加入退出服务器的插件。

### 10月3日 下午8:5
在我的强烈要求下，服务商将后台交给我们团队。
此时为了不影响登录服务器的部署，我没有上后台查看情况。
夜光开始部署登录服务器。

### 10月3日 下午8:17
我进入后台开始设置multipaper，和登录服务器对接。
此时发现，multipaper主服务器并不在这台机器上，并且和他们沟通得知multipaper主服务器在另外一台E5处理器的机器上，并且我没拿到那台机器的后台。得知将multipaper主服务器部署在E5处理器的机器上后结合服务器卡顿的症状，我推断出是multipaper主服务器不堪重负导致的卡顿。
我尝试将multipaper主服务器部署到这台性能强劲的5900K的机器上，并且要求服务商迁移端口映射到这台机器。

### 10月3日 下午8:35

我完成任务后，大米提出了登录服务器的解决方案，我将后台交给大米。并且已经提前打开了我部署好的服务端文件夹，显示在最上面（可能大米没看见）。因为和大米没有语音交流，大米不知道我重新部署了服务端，于是将先前的服务端启动，multipaper主服务器依然在E5的机器上。


### 10月3日 下午8:40
部署完成后玩家蜂拥而至，当服务器玩家数量达到300人时先前的卡顿再次出现。

### 10月3日 下午9:15
庄主已经放弃此次活动并且开始处理后事了。

## 总结
这次出现问题，因为服务商过于自信一直不愿将后台交给我们团队导致此次活动的失败。

最终的定位卡顿的原因是因为multipaper主服务器被放在一台E5处理器的机器上，导致所有服务器交换数据延迟造成的卡顿。






